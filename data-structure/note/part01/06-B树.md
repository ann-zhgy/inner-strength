# B树

## 一、什么是B树

> B树是一种平衡的多路搜索树，多用于文件系统、数据库的实现

* **注意：B树是有顺序的**

![三阶B树](https://i.loli.net/2020/10/09/h6aAfUsudeSCTDN.png)

![四阶B树](https://i.loli.net/2020/10/09/oMBfErT92cpNHC6.png)

![五阶B树](https://i.loli.net/2020/10/09/ke5TjrHD1zbwSi7.png)

## 二、B树有什么特点

1. 一个节点可以存储超过两个元素，可以拥有超过两个子节点
2. 拥有平衡二叉树的一些性质
3. 平衡——每个节点的所有子树高度一致
4. 比较矮……

## 三、m阶B树的性质（m≥2）

> 假设一个节点存储的元素个数为x
>
> `┌ ┐` 表示向上取整，`┕ ┙` 表示向下取整

1. 根节点：`1 ≤ x ≤ m`

2. 非根节点：`┌ m/2 ┐ − 1 ≤ x ≤ m − 1`

> 如果有子节点，子结点的个数 `y = x + 1`

1. 根节点：`2 ≤ y ≤ m`
2. 非根节点：`┌ m/2 ┐ ≤ y ≤ m`
   1. 如m = 3，2 ≤ y ≤ 3，因此可以称为（2, 3）树、2-3树
   2. 如m = 4，2 ≤ y ≤ 4，因此可以称为（2, 4）树、2-3-4树
   3. 如m = 5，3 ≤ y ≤ 5，因此可以称为（3, 5）树
   4. 如m = 6，3 ≤ y ≤ 6，因此可以称为（3, 6）树

## 四、B树 VS 二叉搜索树

> B树和二叉搜索树，在逻辑上是等价的

1. 多代节点合并，可以获得一个超级节点
   * 2 代合并的超级节点，最多拥有 4 个子节点（至少是 4 阶B树）
   * 3 代合并的超级节点，最多拥有 8 个子节点（至少是 8 阶B树）
   * n代合并的超级节点，最多拥有 2<sup>n</sup> 个子节点（ 至少是 2<sup>n</sup> 阶B树）
2. m阶B树，最多需要 log<sub>2</sub>m 代合并

## 五、B树的操作

### 1. 搜索

* 与二叉树的搜索类似
  1. 先在节点内部从小到大开始搜索元素
  2. 如果命中，搜索结束
  3. 如果未命中，再去对应的子节点中搜索元素，重复步骤1

### 2. 添加

* 新添加的元素**必定**是添加到**叶子节点**
* 添加可能有叶子节点的元素个数超过限制的情况，这种现象成为“上溢”

* **上溢的解决：**

  1. 上溢节点的元素数量必定等于 m
  2. 假设上溢节点最中间位置元素为k
     1. 将k位置的元素向上与父节点合并
     2. 将[0, k-1] 和 [k+1, m-1] 位置的元素分裂为两个子节点
     3. 这两个子节点的元素个数，必然都不会低于最低限制（`┌ m/2 ┐ − 1`）

  3. 一次分裂完毕后，有可能导致父节点上溢，依然按照上述方法解决

  * 最极端的情况，有可能一直分裂到根节点

* **B树长高的唯一途径就是元素上溢**

### 3. 删除

> 真正删除的节点一定是叶子节点

1. 假如删除的节点在叶子节点中，那么直接删除即可

2. 假如需要删除的元素在非叶子节点中

   1. 先找到前驱或后继元素，覆盖所需删除元素的值
   2. 再把前驱或后继元素删除

   **非叶子节点的前驱或后继节点必定在叶子节点中**

3. 删除元素可能会出现元素的个数低于最低限制(`≥ ┌ m/2 ┐ − 1`)，这种现象称为**下溢**

4. 下溢的解决

   > 下溢节点的元素数量必然等于`┌ m/2 ┐ − 2`

   1. 如果下溢节点临近的兄弟节点，有至少 `┌ m/2 ┐` 个元素，可以向其借一个元素（其实就是旋转操作）

      1. 将父节点的元素 b 插入到下溢节点的 0位置

         ![1](https://i.loli.net/2020/10/09/8MVQvBAE6oUz29s.png)

      2. 用兄弟节点的元素 a（最大的元素 ）替代父节点b

         ![2](https://i.loli.net/2020/10/09/OjdrX9k2LctqpY6.png)
      
      * **注意：节点d要从a的右边变换到b的左边**
      
   2. 如果下溢节点临近的兄弟节点只有 `┌ m/2 ┐ −` 个元素

      1. 将父节点的元素b移下来和左右子节点进行合并

         ![](https://i.loli.net/2020/10/09/uILR7eQBsaZSKOb.png)

      2. 合并后节点的元素个数一定不超过 `m - 1`

         ![](https://i.loli.net/2020/10/09/zYB2gmDkri8EaI1.png)

   3. 下溢同样可能会不停的向上传播，这是B树高度降低的唯一途径

## 六、四阶B树

> 学习完四阶B树，可以更好地理解红黑树

### 1. 四阶B树的性质

* 所有节点能存储的元素个数 x ：1≤ x≤ 3
* 所有非叶子节点的个数 y ：2≤ y ≤ 4

### 2. 添加

* 从1添加到22

  ![](https://i.loli.net/2020/10/09/2RgS7frUlbNYuOj.png)

### 3. 删除

* 从1删除到22